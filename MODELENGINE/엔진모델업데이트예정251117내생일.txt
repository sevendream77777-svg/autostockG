0. 지금 상태 한 줄 요약

RAW: 2015~오늘까지 전체 종목 안정형 재구축 (Yahoo → Naver → KRX 3단계)

FEATURE / DB / 엔진: 지금 RAW 기준으로 다시 테스트만 통과하면 구조는 완성.

앞으로 할 일:

이 새 RAW로 FEATURE/DB/엔진 재테스트

Top10 생성 스크립트 고정

그 다음부턴 “운영/보완/업그레이드” 단계

아래는 그 운영/보완/업그레이드 관점에서 정리.

1. RAW 레이어(원본 데이터) – 장기 관리 포인트

부분 업데이트 모드 분리

지금은 “풀 빌드(2015~오늘)” 모드만 제대로 설계되어 있음.

앞으로는:

full 모드: 2015~오늘까지 전체 재구축 (가끔만)

incremental 모드: 최근 3~7일만 수집해서 기존 RAW에 머지

이걸 옵션/파라미터로 나눠두면:
→ 평소엔 incremental만 쓰고, 구조 바뀔 때 full 쓰면 됨.

오염 감시 + 재시도 시스템

이번에 만든 3단계 수집 구조 + LOGS는 아주 좋은 시작점.

추후 보완:

failed_codes_YYMMDD.txt 안에 있는 종목만 다시 수집하는 작은 스크립트

날짜 기준으로 “특정 일자에 종목 수가 비정상인 날”만 다시 패치하는 모듈

즉,
👉 “전체 다시 돌리기” 말고
👉 “문제 난 부분만 콕 집어서 다시 받기” 같은 치과치료 모드 필요.

종목 리스트(우주) 관리 – 서바이버십 바이어스

지금은 “현재 살아있는 종목(2763개)” 기준이라,

과거에 상장폐지된 종목은 RAW/엔진에서 아예 빠짐.

이건 실전용 파이프라인으로는 괜찮지만,

“연구용 백테스트”에서 서바이버십 바이어스가 생길 수 있음.

미래 업그레이드 아이디어:

“역사 기준 종목 우주” 따로 만들기
(예: 연도별 종목 리스트 저장 → 그걸로 Research DB 만들기)

데이터 품질 지표 저장

지금은 “오염 로그 파일” 정도인데,

나중엔:

날짜별 종목 수 (평균/최소/최대)

종목별 유효일수(몇 일짜리인지)

이런 걸 parquet/CSV로 따로 저장해두면,

나중에 “데이터 품질이 안 좋았던 시기”만 빼고 백테스트 같은 것도 가능.

2. FEATURE 레이어 – 15피처 유지 + 확장

“무조건 15개만 학습에 사용” 규칙 고정

지금 기준(사실상 룰 확정):

**원본 8개(OHLCV+KOSPI2)**는 DB에만 보존.

학습에는 15개 피처만 사용.

향후 보완:

FEATURE_LIST = [...] 를 config 파일로 빼서

엔진/DB/Top10에서 같은 리스트를 공유하도록 하면 실수 줄어듦.

추가 피처 실험용 파이프라인

나중에 “RSI 말고 Stoch RSI 추가해볼까?” 같은 실험 할 때:

지금 15개는 고정 “메인 피처”

추가 피처들은 “실험 피처”로 따로 붙이고,

Research 엔진에서만 써보는 실험용 브랜치 만드는 것도 좋음.

Feature drift 체크

장기적으로:

최근 1년 vs 과거 5년의 피처 분포 비교 (평균/표준편차 등)

이게 깨지면 “시장이 구조적으로 바뀌었다”는 신호 →
엔진 재훈련 시점 판단에 도움.

3. DB 레이어(HOJ_DB_REAL / RESEARCH) – 룰 명문화

행수/기간 필터

규칙 예:

전체 일수의 20~30% 미만인 종목은 학습 제외

상장 후 60일 이하 종목은 “관찰만 하고 학습 제외”

이건 DB 생성 단계에 필터 한 줄만 넣으면 됨.

장점:

애매하게 59 rows 같은 종목들이 “모델을 망가뜨리지 않도록” 방어.

RESEARCH vs REAL 분리 원칙

RESEARCH:

전체 기간 학습

최근 1년만 검증(early stopping)

성능/실험/튜닝용

REAL:

전체 기간 학습

검증 없이 전체 데이터로 최종 모델만 뽑기

이 규칙은 이미 머릿속엔 있지만,
→ 코드/주석/메모에 확실히 박아둔 상태로 유지.

타깃/라벨 설계 확장

지금은 5d 수익률+Label_5d 중심.

추후 업그레이드:

1d/5d/20d/60d 멀티타겟

수익률 말고 MDD 제한 조건 있는 타겟 (리스크 조정 수익률)

이건 DB단에서 라벨 열 몇 개 더 만드는 작업으로 확장 가능.

4. 엔진 레이어(모델) – 튜닝/안정성 관점

LightGBM 하이퍼파라미터 관리

지금은 아마 V31 기준으로 적당한 파라메터 셋 고정.

나중에 시도해볼 것:

연도별/시장상황별 그리드서치,

“연구 엔진(R)”만 자동 튜닝 →
결과 좋아지면 REAL에 반영.

크로스밸리데이션 확장

현재: “최근 1년” 단일 validation.

나중: 롤링 윈도우 검증 (예: 최근 1년/2년/코로나 구간 등 여러 기간)

장점:

“특정 한 해에만 우연히 잘 나온 모델”을 걸러내기 좋음.

모델 버전 관리

지금도 V31, V32 이런 식으로 버전 달고 있는데:

추천: 각 버전마다 config + 결과 요약 한 줄 저장

예: HOJ_ENGINE_REAL_V31 → 성능요약(json/txt)

그러면 나중에 “어느 버전이 제일 좋았는지” 한 번에 비교 가능.

5. Top10 & 실전 운영 – 주의 포인트

Top10 추천은 반드시 FEATURE 기준

이건 아까 이미 확정한 룰:

추천용 입력 = features_Vxx (라벨 없는 순수 피처)

HOJ_DB_REAL을 쓰면 “라벨 때문에 최신 5일이 잘려서 밀리는 문제” 발생 → 절대 금지.

Top10 결과 저장 구조

매일:

Top10_YYYYMMDD.csv 같은 파일,

컬럼: Date, Code, Score, Rank, 종가, 그날 특징 등.

장점:

과거 추천 히스토리 백테스트하기 쉬움.

나중에 “우리 엔진이 실제로 얼마나 맞췄나?” 바로 검증 가능.

실전/모의 분리

나중에 키움/REST로 실제 매매 붙일 때:

“모의 모드”랑 “실전 모드”를 확실히 스위치로 나눠두는 거 필수.

같은 Top10을 두 라인에 다른 자금/룰로 굴릴 수도 있음.

6. 자동화 / UI / 안전장치

full_update_pipeline_v2

최종적으로는 이런 스크립트 하나 있으면 좋음:

python full_update_pipeline_v2.py --mode full
python full_update_pipeline_v2.py --mode incremental


안에서:

RAW 업데이트 (모드에 따라 전체/부분)

FEATURE 빌드

DB 빌드

엔진 학습

Top10 출력
한 번에.

UI에서 “상태/버전” 표시

나중에 UI 만들 때:

RAW 최신 날짜

FEATURE 최신 날짜

DB/엔진 버전

Top10 기준 날짜

이 4줄만 화면에 항상 보여줘도 “지금 내가 보고 있는 게 얼마나 최신인지” 바로 파악 가능.

예외 처리/알람

예:

특정 날짜 RAW 종목 수가 2500 미만이면 경고

Top10 생성이 실패하면 로그 파일+팝업.

추후 업그레이드로 Email/텔레그램 알람 같은 것도 가능.

7. 이후 업그레이드 아이디어(완전 옵션)

섹터/테마 피처 추가 (섹터별 dummy 변수)

거래대금/시총 기반 필터 (너무 작은 종목 제외)

“HOJ + SLE” 하이브리드 (두 엔진 점수 앙상블)

변동성 레짐(장 상승장/하락장/횡보장)에 따른 다른 모델 선택

계좌/리스크 관리 모듈 (종목당 배분, 최대 종목 수, 손절/익절 기준)